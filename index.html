async function aiGenerate() {
    const url = document.getElementById('campaignUrl').value.trim();
    if (!url) return showError('Please enter a URL');

    const loading = document.getElementById('loading');
    const text = document.getElementById('loadingText');
    loading.classList.add('active');
    text.textContent = 'Reading page...';

    try {
        // Use free proxy instead of broken Gemini API
        const prompt = document.getElementById('aiPrompt').value;
        const response = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url));
        const pageText = await response.text();

        text.textContent = 'Generating content with AI...';

        const aiResponse = await fetch('https://api.grokproxy.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: "grok-beta",
                messages: [{
                    role: "user",
                    content: `${prompt}\n\nPage content (first 3000 chars):\n${pageText.substring(0,3000)}`
                }]
            })
        });

        const data = await aiResponse.json();
        const content = data.choices[0].message.content;

        // Extract JSON if present, otherwise parse manually
        let json;
        try {
            json = JSON.parse(content.match(/\{[\s\S]*\}/)[0]);
        } catch {
            // fallback parsing
            json = {
                section1: content.split('\n\n')[0] || "",
                section2: content.split('\n\n')[1] || "",
                section3: content.split('\n\n')[2] || "",
                section4: content.split('\n\n')[3] || "",
                buttonText: "Learn More",
                buttonLink: url
            };
        }

        ['section1','section2','section3','section4'].forEach((s,i) => 
            document.getElementById(s).value = json[s] || json[`section${i+1}`] || ""
        );
        document.getElementById('buttonText').value = json.buttonText || "Learn More";
        document.getElementById('buttonLink').value = json.buttonLink || url;

        loading.classList.remove('active');
        alert('AI content generated successfully!');

    } catch (err) {
        loading.classList.remove('active');
        showError('AI failed: ' + err.message);
    }
}
