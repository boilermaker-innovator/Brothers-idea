<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iTabs Generator - Create Your Interactive Popup</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f8f9fa;
            line-height: 1.6;
        }
        .hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 60px 20px 40px;
        }
        .hero h1 { font-size: 2.5em; margin-bottom: 15px; font-weight: 700; }
        .hero p { font-size: 1.3em; opacity: 0.95; }
        .free-badge {
            background: #4CAF50; color: white; padding: 5px 12px; border-radius: 20px;
            font-size: 0.5em; font-weight: bold; margin-left: 10px; vertical-align: middle;
        }
        .container { max-width: 900px; margin: -20px auto 40px; padding: 0 20px; }
        .instruction-box {
            background: white; border-left: 4px solid #4285F4; padding: 20px;
            margin-bottom: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .instruction-box h3 { color: #4285F4; margin-bottom: 15px; font-size: 1.3em; }
        .form-section {
            background: white; padding: 30px; border-radius: 12px; margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .form-section h2 {
            color: #333; margin-bottom: 25px; font-size: 1.8em; border-bottom: 3px solid #667eea; padding-bottom: 10px;
        }
        .ai-section {
            background: linear-gradient(135deg, #E8F0FE 0%, #F8E8FF 100%); border: 2px solid #667eea;
        }
        .ai-section h2 { color: #667eea; }
        .form-group { margin-bottom: 25px; }
        label {
            display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 1.05em;
        }
        input[type="text"], input[type="url"], input[type="file"], input[type="password"],
        textarea, select {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px;
            font-size: 15px; transition: border-color 0.3s;
        }
        input:focus, textarea:focus { outline: none; border-color: #667eea; }
        textarea { min-height: 100px; resize: vertical; }
        textarea.prompt-area { min-height: 80px; background: #f8f9fa; font-family: 'Courier New', monospace; font-size: 14px; }
        small { color: #666; display: block; margin-top: 6px; font-size: 13px; }
        .file-status { color: #28a745; font-size: 13px; margin-top: 8px; display: none; font-weight: 600; }
        .file-status.show { display: block; }
        .or-divider {
            text-align: center; margin: 20px 0; color: #999; font-style: italic; font-weight: 600; position: relative;
        }
        .or-divider::before, .or-divider::after {
            content: ""; position: absolute; top: 50%; width: 40%; height: 1px; background: #ddd;
        }
        .or-divider::before { left: 0; }
        .or-divider::after { right: 0; }
        .additional-images {
            margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ddd;
        }
        .image-input-group {
            margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px;
            border: 2px solid #e0e0e0; position: relative;
        }
        .btn-remove-image {
            position: absolute; top: 10px; right: 10px; padding: 6px 12px; background: #f44336;
            color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;
        }
        .btn-add-image {
            width: 100%; padding: 12px; background: #667eea; color: white; border: none;
            border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: bold; margin-top: 10px;
        }
        .btn-add-image:disabled { opacity: 0.5; cursor: not-allowed; }
        .image-count { text-align: center; color: #667eea; font-weight: 600; margin-top: 10px; }
        .button-group { display: flex; gap: 15px; margin-top: 25px; }
        button {
            padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .btn-ai-generate { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; flex: 1; font-size: 18px; }
        .btn-generate { background: #4CAF50; color: white; flex: 1; }
        .btn-clear { background: #f44336; color: white; }
        .btn-copy { background: #2196F3; color: white; width: 100%; }
        .loading { display: none; text-align: center; padding: 25px; color: #666; }
        .loading.active { display: block; }
        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%;
            width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message, .success-message {
            padding: 15px; border-radius: 6px; margin-top: 15px; display: none;
        }
        .error-message.active { display: block; background: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; }
        .success-message.active { display: block; background: #4CAF50; color: white; text-align: center; font-weight: 600; }
        .preview-section { display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .preview-section.active { display: block; }
        .image-container {
            position: relative; width: 100%; height: 350px; overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); cursor: pointer;
        }
        .carousel-wrapper { position: relative; width: 100%; height: 100%; overflow: hidden; }
        .carousel-track { display: flex; transition: transform 0.4s ease; height: 100%; }
        .carousel-slide { min-width: 100%; height: 100%; position: relative; }
        .preview-image { width: 100%; height: 100%; object-fit: cover; }
        .preview-overlay {
            position: absolute; color: white; font-weight: bold; font-size: 18px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8); padding: 10px; z-index: 10;
            left: 50%; transform: translateX(-50%); text-align: center; width: 90%; display: none;
        }
        .preview-overlay.show { display: block; }
        .preview-overlay.top { top: 10px; }
        .preview-overlay.center { top: 50%; transform: translate(-50%, -50%); }
        .preview-overlay.bottom { bottom: 10px; }
        .carousel-nav {
            position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9);
            color: #667eea; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px;
            cursor: pointer; z-index: 15; opacity: 0; transition: all 0.3s;
        }
        .image-container:hover .carousel-nav { opacity: 1; }
        .carousel-nav.prev { left: 15px; }
        .carousel-nav.next { right: 15px; }
        .carousel-indicators {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; z-index: 15;
        }
        .carousel-dot {
            width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,0.5);
            cursor: pointer; border: 2px solid white; transition: all 0.3s;
        }
        .carousel-dot.active { background: white; width: 12px; height: 12px; }
        .image-counter {
            position: absolute; bottom: 15px; right: 15px; background: rgba(0,0,0,0.6);
            color: white; padding: 5px 12px; border-radius: 15px; font-size: 14px; font-weight: bold; z-index: 15;
        }
        .itabs-button {
            position: absolute; top: 20px; right: 20px; width: 45px; height: 45px;
            background: rgba(255,255,255,0.95); color: #667eea; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px;
            cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.2); border: 3px solid white; z-index: 20;
        }
        .itabs-popup {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; padding: 20px;
        }
        .itabs-popup.active { display: flex; }
        .popup-content {
            background: white; border-radius: 20px; width: 90%; max-width: 600px; max-height: 80vh;
            overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
            padding: 30px; display: flex; justify-content: space-between; align-items: center;
        }
        .close {
            background: none; border: none; color: white; font-size: 40px; cursor: pointer;
            width: 40px; height: 40px; border-radius: 50%;
        }
        .modal-body { padding: 35px; max-height: calc(80vh - 120px); overflow-y: auto; }
        .popup-button {
            display: block; margin: 25px 35px; padding: 15px; background: #4CAF50; color: white;
            text-align: center; text-decoration: none; border-radius: 8px; font-weight: bold;
        }
        .code-box {
            background: #2d3748; color: #e2e8f0; padding: 20px; border-radius: 8px;
            font-family: 'Courier New', monospace; font-size: 13px; overflow-x: auto; white-space: pre-wrap;
        }
        @media (max-width: 768px) {
            .hero h1 { font-size: 2em; }
            .button-group { flex-direction: column; }
            button { width: 100%; }
            .image-container { height: 280px; }
        }
    </style>
</head>
<body>
    <div class="hero">
        <h1>iTabs Generator<span class="free-badge">100% FREE</span></h1>
        <p>Create beautiful information popups in 60 seconds with AI</p>
    </div>

    <div class="container">
        <div class="instruction-box">
            <h3>How It Works:</h3>
            <ol>
                <li>Get your <strong>FREE</strong> Google API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com/app/apikey</a></li>
                <li>Paste your campaign/product URL</li>
                <li>Add up to 5 images</li>
                <li>Click "Generate with AI"</li>
                <li>Review & click "Generate iTabs Code"</li>
                <li>Copy and paste on your site!</li>
            </ol>
        </div>

        <div class="form-section ai-section">
            <h2>AI-Powered iTabs Generator</h2>
            
            <div class="form-group">
                <label>Campaign/Product URL:</label>
                <input type="url" id="campaignUrl" value="https://www.birchal.com/company/bioanalytics">
            </div>

            <div class="form-group">
                <label>AI Instructions:</label>
                <textarea id="aiPrompt" class="prompt-area">Read this page and extract the key information. Write 4 short sections (2-3 sentences each) in simple, clear language. Focus on what it is, why it matters, how it works, and what makes it special.</textarea>
            </div>

            <div class="form-group">
                <label>Product Images (Image #1):</label>
                <input type="file" id="imageUpload" accept="image/*">
                <div id="uploadStatus" class="file-status">Image uploaded successfully</div>
                <div class="or-divider">OR</div>
                <input type="url" id="imageUrl" value="https://i.ibb.co/391375nn/IMG-3599.jpg">
                
                <div class="additional-images">
                    <h4>Add up to 4 more images (carousel)</h4>
                    <div id="additionalImagesContainer"></div>
                    <button type="button" class="btn-add-image" id="addImageBtn">+ Add Another Image</button>
                    <div class="image-count" id="imageCount"></div>
                </div>
            </div>

            <div class="form-group">
                <label>Your Google API Key (FREE):</label>
                <input type="password" id="apiKey" placeholder="Get free at aistudio.google.com/app/apikey">
            </div>

            <div class="form-group">
                <label>ImgBB API Key (Optional - for auto-hosting):</label>
                <input type="password" id="imgbbKey" placeholder="Get free at api.imgbb.com">
                <small style="color:#e74c3c;">Warning: Old default key no longer works! Get your own free key.</small>
            </div>

            <div class="button-group">
                <button class="btn-ai-generate" id="aiGenerateBtn">Generate with AI</button>
            </div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p id="loadingText">Working...</p>
            </div>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <div class="form-section">
            <h2>Review & Edit Content</h2>
            <div class="form-group">
                <label>Text Overlay:</label>
                <input type="text" id="overlayText" value="Click the i for more info">
            </div>
            <div class="form-group">
                <label>Overlay Color:</label>
                <select id="overlayColor"><option value="white">White</option><option value="black">Black</option></select>
            </div>
            <div class="form-group">
                <label>Overlay Position:</label>
                <select id="overlayPosition">
                    <option value="top">Top</option>
                    <option value="center" selected>Center</option>
                    <option value="bottom">Bottom</option>
                </select>
            </div>
            <div class="form-group"><label>What is it?</label><textarea id="section1"></textarea></div>
            <div class="form-group"><label>Why do I need it?</label><textarea id="section2"></textarea></div>
            <div class="form-group"><label>How does it work?</label><textarea id="section3"></textarea></div>
            <div class="form-group"><label>What makes it different?</label><textarea id="section4"></textarea></div>
            <div class="form-group"><label>Button Text:</label><input type="text" id="buttonText" value="Learn More"></div>
            <div class="form-group"><label>Button Link:</label><input type="url" id="buttonLink"></div>
            
            <div class="button-group">
                <button class="btn-generate" id="generateBtn">Generate iTabs Code</button>
                <button class="btn-clear" id="clearBtn">Clear Form</button>
            </div>
        </div>

        <div class="preview-section" id="previewSection">
            <h2>Preview Your iTabs</h2>
            <p class="preview-subtitle">Click the "i" button to test! <span id="previewImageInfo"></span></p>
            <div style="background:white;border-radius:20px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.1);max-width:500px;margin:0 auto 30px;">
                <div class="image-container" id="imageContainer">
                    <div class="carousel-wrapper"><div class="carousel-track" id="carouselTrack"></div></div>
                    <button class="carousel-nav prev" id="prevBtn">‹</button>
                    <button class="carousel-nav next" id="nextBtn">›</button>
                    <div class="carousel-indicators" id="carouselIndicators"></div>
                    <div class="image-counter" id="imageCounterDisplay">1/1</div>
                    <div class="itabs-button" id="previewItabsBtn">i</div>
                </div>
                <div style="padding:25px;text-align:center;">
                    <h3 style="font-size:1.3em;color:#2d3748;margin-bottom:10px;">Your iTabs Preview</h3>
                    <p style="color:#718096;">This is how it will look on your website</p>
                </div>
            </div>
            <div class="code-section">
                <h3>Your iTabs Code</h3>
                <p>Copy and paste anywhere on your site:</p>
                <div class="code-box" id="codeBox"></div>
                <button class="btn-copy" id="copyBtn">Copy Code</button>
                <div class="success-message" id="successMessage">Code copied!</div>
            </div>
        </div>
    </div>

    <div class="itabs-popup" id="itabsPopup">
        <div class="popup-content">
            <div class="modal-header">
                <h3>Your Product</h3>
                <button class="close" id="closeBtn">×</button>
            </div>
            <div class="modal-body">
                <h4>What is it?</h4><p id="popupSection1"></p>
                <h4>Why do I need it?</h4><p id="popupSection2"></p>
                <h4>How does it work?</h4><p id="popupSection3"></p>
                <h4>What makes it different?</h4><p id="popupSection4"></p>
                <a href="#" id="popupButton" class="popup-button" target="_blank">Learn More</a>
            </div>
        </div>
    </div>

    <script>
        let uploadedImageData = null;
        let additionalUploadedImages = {};
        let additionalImageCount = 0;
        const MAX_IMAGES = 5;
        let previewImages = [];
        let previewCarouselIndex = 0;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('aiGenerateBtn').addEventListener('click', aiGenerate);
            document.getElementById('generateBtn').addEventListener('click', generatePreview);
            document.getElementById('clearBtn').addEventListener('click', clearForm);
            document.getElementById('copyBtn').addEventListener('click', copyCode);
            document.getElementById('previewItabsBtn').addEventListener('click', () => document.getElementById('itabsPopup').classList.add('active'));
            document.getElementById('closeBtn').addEventListener('click', () => document.getElementById('itabsPopup').classList.remove('active'));
            document.getElementById('addImageBtn').addEventListener('click', addImageInput);
            document.getElementById('prevBtn').addEventListener('click', () => moveCarousel(-1));
            document.getElementById('nextBtn').addEventListener('click', () => moveCarousel(1));
            document.getElementById('itabsPopup').addEventListener('click', e => e.target === e.currentTarget && e.currentTarget.classList.remove('active'));

            // Touch swipe
            document.getElementById('imageContainer').addEventListener('touchstart', e => touchStartX = e.touches[0].screenX, {passive:true});
            document.getElementById('imageContainer').addEventListener('touchend', e => {
                const diff = e.changedTouches[0].screenX - touchStartX;
                if (Math.abs(diff) > 50) moveCarousel(diff < 0 ? 1 : -1);
            }, {passive:true});

            document.getElementById('imageUpload').addEventListener('change', handleMainImageUpload);
            document.getElementById('imageUrl').addEventListener('input', () => {
                if (this.value.trim()) {
                    document.getElementById('imageUpload').value = '';
                    uploadedImageData = null;
                }
            });

            updateAddButtonState();
        });

        let touchStartX = 0;

        function handleMainImageUpload(e) {
    const file = e.target.files[0];
    if (!file || !file.type.startsWith('image/')) return alert('Invalid image');
    const reader = new FileReader();
    reader.onload = ev => {
        uploadedImageData = ev.target.result;
        const status = document.getElementById('uploadStatus');
        status.classList.add('show');
        const key = document.getElementById('imgbbKey').value.trim();
        key ? uploadToImgBB(file, key, 'imageUrl', status) : status.textContent = 'Image ready (local only)';
    };
    reader.readAsDataURL(file);
}

async function uploadToImgBB(file, key, targetId, statusEl) {
    statusEl.textContent = 'Uploading...';
    try {
        const form = new FormData();
        form.append('image', file);
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${key}`, {method:'POST', body:form});
        const data = await res.json();
        if (data.success) {
            document.getElementById(targetId).value = data.data.url;
            statusEl.textContent = 'Uploaded to ImgBB!';
            statusEl.style.color = '#28a745';
        } else throw new Error();
    } catch {
        statusEl.textContent = 'Upload failed (using local)';
        statusEl.style.color = '#ffc107';
    }
}
                } else throw new Error();
            } catch {
                statusEl.textContent = 'Upload failed (using local)';
                statusEl.style.color = '#ffc107';
            }
        }

        function addImageInput() {
            if (additionalImageCount >= 4) return alert('Max 5 images');
            additionalImageCount++;
            const num = additionalImageCount + 1;
            const div = document.createElement('div');
            div.className = 'image-input-group';
            div.innerHTML = `
                <button type="button" class="btn-remove-image" onclick="this.parentElement.remove();additionalImageCount--;updateAddButtonState();updateImageCount();">Remove</button>
                <label>Image #${num}:</label>
                <input type="file" class="additional-image-upload" accept="image/*">
                <div class="file-status" id="status${num}"></div>
                <div class="or-divider">OR</div>
                <input type="url" class="additional-image-url" placeholder="Image URL">
            `;
            document.getElementById('additionalImagesContainer').appendChild(div);
            div.querySelector('.additional-image-upload').addEventListener('change', function() {
                const file = this.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    additionalUploadedImages[num] = e.target.result;
                    const status = document.getElementById('status'+num);
                    status.classList.add('show');
                    const key = document.getElementById('imgbbKey').value.trim();
                    key ? uploadToImgBB(file, key, div.querySelector('.additional-image-url'), status) : status.textContent = 'Image ready (local)';
                };
                reader.readAsDataURL(file);
            });
            updateImageCount();
            updateAddButtonState();
        }

        function updateImageCount() {
            const el = document.getElementById('imageCount');
            const total = additionalImageCount + 1;
            el.textContent = total > 1 ? `Total: ${total} images` : '';
        }

        function updateAddButtonState() {
            const btn = document.getElementById('addImageBtn');
            btn.disabled = additionalImageCount >= 4;
            btn.textContent = btn.disabled ? 'Max 5 Images Reached' : '+ Add Another Image';
        }

        function getAllImageUrls() {
            const urls = [];
            const mainUrl = document.getElementById('imageUrl').value.trim();
            if (mainUrl) urls.push(mainUrl);
            else if (uploadedImageData) urls.push(uploadedImageData);

            document.querySelectorAll('.additional-image-url').forEach(input => {
                if (input.value.trim()) urls.push(input.value.trim());
                else {
                    const num = input.closest('.image-input-group').querySelector('input[type=file]').closest('.image-input-group').querySelector('.additional-image-upload').parentElement.querySelector('label').textContent.match(/#(\d+)/)[1];
                    if (additionalUploadedImages[num]) urls.push(additionalUploadedImages[num]);
                }
            });
            return urls;
        }

        function buildCarousel(imgs, overlay, pos, color) {
            const track = document.getElementById('carouselTrack');
            const dots = document.getElementById('carouselIndicators');
            track.innerHTML = ''; dots.innerHTML = '';
            imgs.forEach((src, i) => {
                const slide = document.createElement('div');
                slide.className = 'carousel-slide';
                slide.innerHTML = `<img src="${src}" class="preview-image" alt="Slide ${i+1}">`;
                if (i === 0 && overlay) {
                    const ov = document.createElement('div');
                    ov.className = `preview-overlay show ${pos}`;
                    ov.style.color = color;
                    ov.textContent = overlay;
                    slide.appendChild(ov);
                }
                track.appendChild(slide);

                const dot = document.createElement('div');
                dot.className = 'carousel-dot';
                if (i===0) dot.classList.add('active');
                dot.onclick = () => { previewCarouselIndex = i; updateCarouselDisplay(); };
                dots.appendChild(dot);
            });
            previewImages = imgs;
            updateCarouselDisplay();
        }

        function moveCarousel(dir) {
            if (previewImages.length <= 1) return;
            previewCarouselIndex = (previewCarouselIndex + dir + previewImages.length) % previewImages.length;
            updateCarouselDisplay();
        }

        function updateCarouselDisplay() {
            document.getElementById('carouselTrack').style.transform = `translateX(-${previewCarouselIndex * 100}%)`;
            document.querySelectorAll('.carousel-dot').forEach((d,i) => d.classList.toggle('active', i===previewCarouselIndex));
            document.getElementById('imageCounterDisplay').textContent = `${previewCarouselIndex+1}/${previewImages.length}`;
            const nav = document.querySelectorAll('.carousel-nav, .carousel-indicators, .image-counter');
            nav.forEach(el => el.style.display = previewImages.length > 1 ? 'block' : 'none');
        }

        async function aiGenerate() {
            const url = document.getElementById('campaignUrl').value.trim();
            const key = document.getElementById('apiKey').value.trim();
            if (!url || !key) return showError('Missing URL or API key');

            const loading = document.getElementById('loading');
            const text = document.getElementById('loadingText');
            loading.classList.add('active');

            try {
                text.textContent = 'Reading page...';
                const content = await fetch(`https://r.jina.ai/${url}`).then(r => r.text());
                text.textContent = 'Generating content...';

                const prompt = document.getElementById('aiPrompt').value + "\n\nContent:\n" + content.substring(0,4000) +
                    "\n\nRespond exactly in this JSON format:\n{ \"section1\": \"...\", \"section2\": \"...\", \"section3\": \"...\", \"section4\": \"...\", \"buttonText\": \"...\", \"buttonLink\": \""+url+"\" }";

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({contents: [{parts: [{text: prompt}]}]})
                });
                const data = await res.json();
                const json = JSON.parse(data.candidates[0].content.parts[0].text.match(/\{[\s\S]*\}/)[0]);

                ['section1','section2','section3','section4'].forEach((s,i) => document.getElementById(s).value = json[s]);
                document.getElementById('buttonText').value = json.buttonText;
                document.getElementById('buttonLink').value = json.buttonLink;

                loading.classList.remove('active');
                alert('AI content generated! Review and click Generate Code');
            } catch (err) {
                loading.classList.remove('active');
                showError('AI Error: ' + err.message);
            }
        }

        function generatePreview() {
            const imgs = getAllImageUrls();
            if (!imgs.length) return alert('Add at least one image');
            if (!document.getElementById('section1').value.trim()) return alert('Fill all sections or use AI');

            const overlay = document.getElementById('overlayText').value.trim();
            const pos = document.getElementById('overlayPosition').value;
            const color = document.getElementById('overlayColor').value;

            buildCarousel(imgs, overlay, pos, color);
            document.getElementById('previewImageInfo').innerHTML = imgs.length > 1 ? '<span style="color:#667eea;font-weight:bold;">Swipe or arrows to see all images!</span>' : '';

            ['1','2','3','4'].forEach(n => document.getElementById('popupSection'+n).textContent = document.getElementById('section'+n).value);
            document.getElementById('popupButton').textContent = document.getElementById('buttonText').value;
            document.getElementById('popupButton').href = document.getElementById('buttonLink').value || '#';

            document.getElementById('codeBox').textContent = generateCode(imgs, overlay, pos, color,
                document.getElementById('section1').value,
                document.getElementById('section2').value,
                document.getElementById('section3').value,
                document.getElementById('section4').value,
                document.getElementById('buttonText').value,
                document.getElementById('buttonLink').value
            );

            document.getElementById('previewSection').classList.add('active');
            document.getElementById('previewSection').scrollIntoView({behavior:'smooth'});
        }

        function generateCode(imgs, overlay, pos, color, s1, s2, s3, s4, btnText, btnLink) {
            const posStyle = pos === 'top' ? 'top:10px;' : pos === 'center' ? 'top:50%;transform:translate(-50%,-50%);' : 'bottom:10px;';
            let slides = '';
            imgs.forEach((url, i) => {
                const ov = (i===0 && overlay) ? `<div style="position:absolute;${posStyle}left:50%;transform:translateX(-50%);color:${color};font-weight:bold;font-size:18px;text-shadow:2px 2px 4px rgba(0,0,0,0.8);padding:10px;z-index:10;text-align:center;width:90%;">${overlay}</div>` : '';
                slides += `<div style="min-width:100%;height:100%;"><img src="${url}" style="width:100%;height:100%;object-fit:cover;">${ov}</div>`;
            });

            let controls = '';
            if (imgs.length > 1) {
                let dots = '';
                imgs.forEach((_,i) => dots += `<div class="itabs-dot" data-slide="${i}" style="width:10px;height:10px;border-radius:50%;background:${i===0?'white':'rgba(255,255,255,0.5)'};cursor:pointer;border:2px solid white;margin:0 4px;"></div>`);
                controls = `
                    <button onclick="itabsMove(-1)" style="position:absolute;top:50%;left:15px;transform:translateY(-50%);background:rgba(255,255,255,0.9);color:#667eea;border:none;width:40px;height:40px;border-radius:50%;font-size:20px;cursor:pointer;z-index:15;">‹</button>
                    <button onclick="itabsMove(1)" style="position:absolute;top:50%;right:15px;transform:translateY(-50%);background:rgba(255,255,255,0.9);color:#667eea;border:none;width:40px;height:40px;border-radius:50%;font-size:20px;cursor:pointer;z-index:15;">›</button>
                    <div style="position:absolute;bottom:15px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:15;">${dots}</div>
                    <div id="itabsCounter" style="position:absolute;bottom:15px;right:15px;background:rgba(0,0,0,0.6);color:white;padding:5px 12px;border-radius:15px;font-size:14px;font-weight:bold;z-index:15;">1/${imgs.length}</div>`;
            }

            return `<!-- iTabs Interactive Popup -->
<div style="background:white;border-radius:20px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.1);max-width:500px;margin:20px auto;">
    <div style="position:relative;width:100%;height:350px;overflow:hidden;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
        <div style="position:relative;width:100%;height:100%;overflow:hidden;">
            <div id="itabsTrack" style="display:flex;transition:transform 0.4s ease;height:100%;">${slides}</div>
        </div>
        ${controls}
        <div style="position:absolute;top:20px;right:20px;width:45px;height:45px;background:rgba(255,255,255,0.95);color:#667eea;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:24px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,0.2);border:3px solid white;z-index:20;" onclick="document.getElementById('itabsPopup').style.display='flex'">i</div>
    </div>
    <div style="padding:25px;text-align:center;">
        <h3 style="font-size:1.3em;color:#2d3748;margin-bottom:10px;font-weight:600;">Your Product</h3>
        <p style="color:#718096;">${imgs.length > 1 ? 'Swipe to see more images!' : 'Click the i button'}</p>
    </div>
</div>

<div id="itabsPopup" style="display:none;position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;padding:20px;" onclick="if(event.target===this)this.style.display='none'">
    <div style="background:white;border-radius:20px;width:90%;max-width:600px;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
        <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;font-size:1.8em;">Your Product</h3>
            <button onclick="this.closest('#itabsPopup').style.display='none'" style="background:none;border:none;color:white;font-size:40px;cursor:pointer;">×</button>
        </div>
        <div style="padding:35px;max-height:calc(80vh-120px);overflow-y:auto;">
            <h4 style="color:#667eea;margin:25px 0 15px;font-size:1.4em;">What is it?</h4><p style="color:#4a5568;line-height:1.8;margin-bottom:15px;">${s1}</p>
            <h4 style="color:#667eea;margin:25px 0 15px;font-size:1.4em;">Why do I need it?</h4><p style="color:#4a5568;line-height:1.8;margin-bottom:15px;">${s2}</p>
            <h4 style="color:#667eea;margin:25px 0 15px;font-size:1.4em;">How does it work?</h4><p style="color:#4a5568;line-height:1.8;margin-bottom:15px;">${s3}</p>
            <h4 style="color:#667eea;margin:25px 0 15px;font-size:1.4em;">What makes it different?</h4><p style="color:#4a5568;line-height:1.8;margin-bottom:15px;">${s4}</p>
            <a href="${btnLink}" target="_blank" style="display:block;margin:25px 0;padding:15px;background:#4CAF50;color:white;text-align:center;text-decoration:none;border-radius:8px;font-weight:bold;">${btnText}</a>
        </div>
    </div>
</div>

<script>
var itabsSlide = 0;
const itabsTotal = ${imgs.length};
function itabsMove(n) {
    itabsSlide = (itabsSlide + n + itabsTotal) % itabsTotal;
    document.getElementById('itabsTrack').style.transform = 'translateX(-' + (itabsSlide * 100) + '%)';
    document.getElementById('itabsCounter') && (document.getElementById('itabsCounter').textContent = (itabsSlide+1)+'/${imgs.length}');
    document.querySelectorAll('.itabs-dot').forEach((d,i) => d.style.background = i===itabsSlide ? 'white' : 'rgba(255,255,255,0.5)');
}
document.addEventListener('click', e => {
    if (e.target.classList.contains('itabs-dot')) itabsMove(0, parseInt(e.target.dataset.slide) - itabsSlide);
});
document.getElementById('itabsTrack') && document.getElementById('itabsTrack').addEventListener('touchstart', e => touchStartX = e.touches[0].screenX);
document.getElementById('itabsTrack') && document.getElementById('itabsTrack').addEventListener('touchend', e => {
    const diff = e.changedTouches[0].screenX - touchStartX;
    if (Math.abs(diff) > 50) itabsMove(diff < 0 ? 1 : -1);
});
<\/script>`;
        }

        function showError(msg) {
            const el = document.getElementById('errorMessage');
            el.textContent = msg;
            el.classList.add('active');
        }

        function copyCode() {
            navigator.clipboard.writeText(document.getElementById('codeBox').textContent);
            const msg = document.getElementById('successMessage');
            msg.classList.add('active');
            setTimeout(() => msg.classList.remove('active'), 3000);
        }

        function clearForm() {
            location.reload();
        }
    </script>
</body>
</html>
